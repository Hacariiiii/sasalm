name: Deploy React App to Proxmox

on:
  push:
    branches: [ master]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. RÃ©cupÃ©rer le code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 2. Construire l'image Docker
    - name: Build Docker Imageeee
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/sasalm:latest .
    
    # 3. Pousser sur Docker Hub
    - name: Push to Docker Hub
      run: |
        IMAGE_TAG=${{ github.sha }}
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker tag ${{ secrets.DOCKER_USERNAME }}/sasalm:latest ${{ secrets.DOCKER_USERNAME }}/sasalm:$IMAGE_TAG
        docker push ${{ secrets.DOCKER_USERNAME }}/sasalm:$IMAGE_TAG

    
    # 4. DÃ©ployer sur Proxmox VM
    - name: Deploy to Proxmox VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}       # â† TON IP FIXE
        username: "tython"             # â† TON USER
        key: ${{ secrets.SSH_PRIVATE_KEY }}  # â† TA CLÃ‰
        port: 2701                     # â† PORT 2701 FIXE
        script: |
          echo "ğŸ¯ Connexion SSH Ã©tablie avec succÃ¨s!"
          
          # 1. Se connecter Ã  Docker Hub
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # 2. TÃ©lÃ©charger la derniÃ¨re image
          docker pull ${{ secrets.DOCKER_USERNAME }}/sasalm:latest

          
          # 3. ArrÃªter et supprimer l'ancien container
          docker stop sasalm-app 2>/dev/null || true
          docker rm sasalm-app 2>/dev/null || true
          
          # 4. Lancer le nouveau container
           cd ~/sasalm
          docker compose down
          docker compose pull
          docker compose up -d 

          
          # 5. VÃ©rification
          echo "âœ… DÃ©ploiement rÃ©ussi!"
          echo "ğŸ“Š Container status:"
          docker ps --filter "name=sasalm-app"
          echo "ğŸŒ Application disponible sur: http://135.125.4.184"
