name: Build, Push and Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Build and Push to Docker Hubeee
      run: |
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker build -t ${{ secrets.DOCKER_USERNAME }}/sasalm:${{ github.sha }} .
        docker push ${{ secrets.DOCKER_USERNAME }}/sasalm:${{ github.sha }}
        docker tag ${{ secrets.DOCKER_USERNAME }}/sasalm:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/sasalm:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/sasalm:latest
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          # Variables
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/sasalm"
          
          # 1. Login Docker
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # 2. Pull latest image
          docker pull $IMAGE_NAME:latest
          
          # 3. Stop and remove old container
          docker compose down || true
          
          # 4. Create docker-compose.yml if not exists
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          services:
            sasalm:
              image: $IMAGE_NAME:latest
              container_name: sasalm-app
              ports:
                - "80:80"
                - "443:443"
              restart: unless-stopped
              volumes:
                - ./ssl:/etc/nginx/ssl
          EOF
          
          # 5. Replace image name in docker-compose
          sed -i "s|\$IMAGE_NAME|$IMAGE_NAME|g" docker-compose.yml
          
          # 6. Start new container
          docker compose up -d
          
          # 7. Cleanup
          docker system prune -af --volumes
          
          echo "ðŸš€ Application dÃ©ployÃ©e avec succÃ¨s!"
          echo "ðŸŒ AccÃ©dez Ã : http://${{ secrets.VM_HOST }}"
