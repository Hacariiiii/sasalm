name: Deploy React App to Proxmox

on:
  push:
    branches: [ main , master ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. RÃ©cupÃ©rer le code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 2. Construire l'image Docker
    - name: Build Docker Imageeeee
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/sasalm:latest .
    
    # 3. Pousser sur Docker Hub
    - name: Push to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker push ${{ secrets.DOCKER_USERNAME }}/sasalm:latest
    
    # 4. DÃ©ployer sur Proxmox VM (avec MOT DE PASSE)
    - name: Deploy to Proxmox VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}  # â† CHANGEMENT IMPORTANT
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          echo "ğŸ¯ Connexion SSH Ã©tablie avec succÃ¨s!"
          
          # 1. Se connecter Ã  Docker Hub
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # 2. TÃ©lÃ©charger la derniÃ¨re image
          docker pull ${{ secrets.DOCKER_USERNAME }}/sasalm:latest
          
          # 3. ArrÃªter et supprimer l'ancien container
          docker stop sasalm-app 2>/dev/null || true
          docker rm sasalm-app 2>/dev/null || true
          
          # 4. Lancer le nouveau container
          docker run -d \
            --name sasalm-app \
            -p 80:80 \
            --restart unless-stopped \
            ${{ secrets.DOCKER_USERNAME }}/sasalm:latest
          
          # 5. VÃ©rification
          echo "âœ… DÃ©ploiement rÃ©ussi!"
          echo "ğŸ“Š Container status:"
          docker ps --filter "name=sasalm-app"
          echo "ğŸŒ Application disponible sur: http://${{ secrets.SSH_HOST }}"
